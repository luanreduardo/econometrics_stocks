---
title: "<center> <h2> <b> PETR4 </b> </h2> </center>"
author: "<center> Luan Rezende Eduardo </center>"
output:
  html_document:
    df_print: paged
  pdf_document: default
urlcolor: blue
---

```{r include=FALSE}

source('codes/00_main.R')

```

### Introdução 

Visa-se com este trabalho analisar os dados da série de retornos aproximada obtida a partir do log da diferença da série de preços do ativo financeiro PETR4, modelando a sua média condicional através de um modelo ARIMA e sua volatilidade condicional através de um modelo GARCH, de forma a obter predições sobre o seu comportamento fora da amostra.

A sigla PETR4 se refere as ações preferenciais da estatal brasileira Petrobras S.A. e os códigos utilizados podem ser encontradas no link https://github.com/luanreduardo/econometrics_stocks.

### Análise Exploratória

Utiliza-se a base de dados da Economática contendo os preços de fechamento do ativo PETR4 entre os anos de 1996 e 2019, convertidos em uma série temporal do tipo xts. Após a remoção dos dias de não-atividade do mercado tem-se os preços conforme o seguinte gráfico.

<center>
```{r echo=FALSE}

plot.xts(petr4_xts$PETR4, main = "Preços PETR4")

```
</center>

Posteriormente, aplica-se a diferença do logaritmo para obter uma série aproximada de retornos para este ativo, com o objetivo de obter uma série estacionária, uma vez que esta é condição necessária para a modelagem. Obtém-se, então, a série abaixo.

<center>
```{r echo=FALSE}

plot.xts(petr4_returns, main = "Retornos PETR4")

```
</center>

A partir dos dados aparentemente estacionários da série de retornos, testamos a estacionariedade através de um teste de Dickey-Fuller aumentado, com o número de defasagens sugerido pela função como a raiz cúbica do tamanho da amostra menos 1. Nesse teste a H0 aponta para um passeio aleatório, o presente resultado rejeita H0 indicando a estacionariedade da série.


```{r echo=FALSE}

print(unit_root)

```

Por último, calcula-se as funções de autocorrelação e autocorrelação parcial para se verificar se os seus decaimentos indicam a estacionariedade, os resultados abaixo tem rápido decaimento e corroboram o indicado no teste de Dickey-Fuller.

<center>
```{r echo=FALSE}

plot(acf_petr4_ret, main = "", ylab = "", xlab = "Defasagem")
title("Função de Autocorrelação (FAC)", adj = 0.5, line = 1)
plot(pacf_petr4_ret, main = "", ylab = "", xlab = "Defasagem")
title("Função de Autocorrelação Parcial (FACP)", adj = 0.5, line = 1)

```
</center>

### Modelagem do ARIMA

Para determinar as ordens máximas $p$, $d$ e $q$ utiliza-se os resultados obtidos na análise exploratória. Como a série dos retornos, utilizada a partir daqui, já apresenta estacionariedade não há necessidade de diferenciação adicional, logo $d=0$. Já os gráficos da FAC e da FACP indicam, respectivamente, um MA(1) e um AR(1) máximos, dessa forma testaremos todos os modelos entre ARIMA(0,0,0) e ARIMA(1,0,1).

```{r echo=FALSE}

print(results)

```

Os resultados indicam que modelo de menor AIC e BIC é o ARIMA(0,0,1), ou MA(1), com três parâmetros. Esse, portanto, é o escolhido para os próximos passos.

```{r echo=FALSE}

print(cond_average)

```

### Análise dos Resíduos para o MA(1)

Aqui é feita uma análise dos resíduos para verificar se existem indicativos de padrões não esperados, uma vez que esses devem se comportar como um ruído branco. Para isso, inicia-se com um teste de Ljung-Box para testar se há indicativo de autocorrelação serial dos resíduos, onde o objetivo é aceitar a hipótese de que os resíduos são i.i.d, H0. Tem-se um p-valor < 0.05, evidência contra H0.

```{r echo=FALSE}

print(box_test_arma)

```

Utiliza-se a FAC dos resíduos, indica a ausência de uma autocorrelação.

<center>
```{r echo=FALSE}

plot(acf_residuals, main = "", ylab = "", xlab = "Defasagem")
title("FAC dos resíduos do ARMA(0,1)", adj = 0.5, line = 1)

```
</center>

Já a FAC dos resíduos ao quadrado indica a existência de uma heterocedasticidade condicional nos dados, o que corrobora um fato estilizado do mercado financeiro, que apresenta clusters de volatilidade e onde o módulo de $t-1$ afeta o valor de $t$.

<center>
```{r echo=FALSE}

plot(acf_residuals_square, main = "", ylab = "", xlab = "Defasagem")
title("FAC do quadrado dos resíduos do ARMA(0,1)", adj = 0.5, line = 1)

plot(pacf_residuals_square, main = "", ylab = "", xlab = "Defasagem")
title("FACP do quadrado dos resíduos do ARMA(0,1)", adj = 0.5, line = 1)

```
</center>

A não realização dos testes de Shapiro e Jarque-Bera para normalidade da distribuição dos resíduos é justificado pela pouca confiabilidade de seus resultados para grande amostras, uma vez que pequenas distorções na distribuição já causam a rejeição da hipótese de normalidade adotada para o modelo.

### Modelo ARMA-GARCH

A presença de heterocedasticidade condicional evidenciada pelas funções de autocorrelação e autorrelação parcial torna necessária a adição de uma ferramenta de modelagem da variância condicional da série temporal. Portanto, busca-se a partir daqui modelar um ARIMA-GARCH para os dados.

As funções de FAC e FACP dos resíduos ao quadrados indicam as ordens $m$ e $n$ máximas do modelo de variância condicional GARCH, uma vez que o FAC não entram na banda de aceitação em defasagens muito altas de cientes de que altas ordens não são usuais, opta-se por $m=5$ e $n=5$ conforme FACP. Os resultados de cada composição de ordens segue abaixo, a distribuição adotada foi a t assimétrica.

```{r echo=FALSE}

print(results_arma_garch)

```

Os resultados de obtidos indicam menores AIC e BIC no modelo ARMA(0,1)-GARCH(1,1), definindo o modelo utilizado no restante desse trabalho.

```{r echo=FALSE}

print(chosen_arma_garch)

```

### Análise dos Resíduos MA(1)-GARCH(1,1)

Uma análise similar a feita acima é realizada para testar a presença de autocorrelação serial ou heterocedasticidade condicional dos resíduos, agora no novo modelo ARMA-GARCH. Inicia-se com os resultados do teste de Dickey-Fuller aumentado, que sugere aceitar que os resíduos são i.i.d, ou seja, H0.

```{r echo=FALSE}

print(box_test_garch)

```

Abaixo, o gráfico da função de autocorrelação dos resíduos padronizados ao quadrado também sugere a ausência de heterocedasticidade.

<center>
```{r echo=FALSE}

acf_residuals_square_arma_garch <- acf(fGarch::residuals(chosen_arma_garch, standardize = TRUE)^2, 
                                       na.action = na.pass, plot = FALSE, lag.max = 20)
plot(acf_residuals_square_arma_garch, main = "", ylab = "", xlab = "Defasagem")
title("FAC do quadrado dos resíduos do ARMA(0,1)-GARCH(1,1)", adj = 0.5, line = 1)

```
</center>

O modelo proposto parece capturar os padrões dos dados e a análise dos resíduos mostra que eles apresentam um bom comportamento

O resultado do ARMA(0,1)-GARCH(1,1) é expresso no gráfico abaixo

<center>
```{r echo=FALSE}

plot(chosen_arma_garch, which = 1)

```
</center>

### Predições e acurácia

Por fim, uma previsão de 63 períodos é calculada com os seguintes valores de média e variância para cada período $T + i$ a partir de 30 de setembro de 2019.

```{r echo=FALSE}

print(arima_garch_forecast)

```

A partir do qual plota-se os gráficos contendo os dados in-sample desde maio até o final de setembro, com a previsão dentro da banda de 1 sigma e também a previsão para o sigma incondicional, respectivamente.

<center>
```{r echo=FALSE}

fGarch::plot(arima_garch_forecast, which = 1)
fGarch::plot(arima_garch_forecast, which = 3)

```
</center>

Um gráfico com os as previsões de média (em verde) e uma banda de dois sigma (média + sigma, média - sigma; em vermelho) juntamente com os dados de retornos dos meses de outubro, novembro e dezembro é plotado.

<center>
```{r echo=FALSE}

plot.ts(out_of_sample_return , col = "blue", ylim = ylim, main = '63 períodos fora da amostra')
lines(mean_arma_garch,col = "green", ylim = ylim, lwd  = 2)
lines(upper_bound_garch, col = "red", ylim = ylim, lwd = 2)
lines(lower_bound_garch, col = "red", ylim = ylim, lwd = 2)

```
</center>

\break 